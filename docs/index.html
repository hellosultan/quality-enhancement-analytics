<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Quality Enhancement Analytics</title>

  <!-- Fonts & libs -->
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800&display=swap" rel="stylesheet" />
  <script src="https://cdn.plot.ly/plotly-2.34.0.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>
  <link  href="https://cdn.datatables.net/1.13.6/css/jquery.dataTables.min.css" rel="stylesheet"/>
  <script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
  <script src="https://cdn.datatables.net/1.13.6/js/jquery.dataTables.min.js"></script>

  <style>
    :root{ --bg:#f6f7fb; --ink:#0f172a; --muted:#64748b; --accent:#2563eb; --card:#ffffff; --ring:#e5e7eb; }
    *{box-sizing:border-box}
    body{margin:0;font-family:Inter,system-ui,Segoe UI,Roboto,Arial;background:var(--bg);color:var(--ink)}
    header{background:#111827;color:#e5e7eb;padding:18px 20px;font-weight:800;font-size:26px}
    main{max-width:1200px;margin:22px auto;padding:0 18px}
    .kpis{display:grid;grid-template-columns:repeat(4,1fr);gap:14px;margin-bottom:14px}
    .card{background:var(--card);border:1px solid var(--ring);border-radius:14px;padding:16px}
    .kpi-title{color:var(--muted);font-size:13px}
    .kpi-val{font-size:26px;font-weight:800;margin-top:6px}
    .grid{display:grid;grid-template-columns:1fr;gap:14px}
    @media(min-width:1100px){.grid{grid-template-columns:1fr 1fr}}
    .caption{color:var(--muted);font-size:12px;margin-top:6px}
    table.dataTable thead th{background:#f8fafc}
  </style>
</head>
<body>
<header>Quality Enhancement Analytics</header>

<main>
  <!-- KPI cards -->
  <div class="kpis">
    <div class="card"><div class="kpi-title">Overall pass rate</div><div class="kpi-val" id="kpiPass">—</div></div>
    <div class="card"><div class="kpi-title">Assessments returned ≤15d</div><div class="kpi-val" id="kpiTurn">—</div></div>
    <div class="card"><div class="kpi-title">Median engagement index</div><div class="kpi-val" id="kpiEng">—</div></div>
    <div class="card"><div class="kpi-title">At‑risk modules</div><div class="kpi-val" id="kpiRisk">—</div></div>
  </div>

  <!-- Charts -->
  <div class="grid">
    <div class="card"><h3>Programme Pass Rates by Term</h3><div id="fig1" style="height:360px"></div></div>
    <div class="card"><h3>Assessment Turnaround Distribution</h3><div id="fig2" style="height:360px"></div><div class="caption">Each bar = number of assessments in that turnaround bin.</div></div>
    <div class="card"><h3>Engagement vs Pass Rate</h3><div id="fig3" style="height:360px"></div><div class="caption">Each dot = a programme/term combination.</div></div>
    <div class="card"><h3>Modules: Pass vs Survey Satisfaction</h3><div id="fig4" style="height:360px"></div><div class="caption">Each dot = a module. Red = low satisfaction & pass.</div></div>
    <div class="card"><h3>Segment #5 — Medium‑to‑Low Engagement & Pass</h3><div id="fig5" style="height:360px"></div></div>
    <div class="card"><h3>Segment #6 — Modules with Medium‑to‑Low Pass</h3><div id="fig6" style="height:360px"></div></div>
  </div>

  <!-- Data table -->
  <div class="card" style="margin-top:14px">
    <h3>Module Summary</h3>
    <table id="modTable" class="display" style="width:100%"></table>
    <div class="caption">Source: <code>docs/data/*.csv</code>. All data are synthetic for demo.</div>
  </div>
</main>

<script>
(async function () {
  // ---------- helpers ----------
  const bust = (p) => p + (p.includes("?") ? "&" : "?") + "v=" + Date.now();
  const bottomLegend = () => ({ orientation:"h", y:-0.2, x:0.5, xanchor:"center", yanchor:"top" });

  // CSV loader: trims headers & values; skips empty lines
  const loadCSV = async (path) => new Promise((resolve, reject) => {
    Papa.parse(path, {
      download: true,
      header: true,
      dynamicTyping: true,
      skipEmptyLines: "greedy",
      transformHeader: (h) => (h || "").trim(),
      transform: (v) => (typeof v === "string" ? v.trim() : v),
      complete: (res) => resolve(res.data || []),
      error: reject
    });
  });

  // ---------- load CSVs from docs/data ----------
  const base = "data/";
  let progPass = [], turn = [], eng = [], risk = [];
  try {
    [progPass, turn, eng, risk] = await Promise.all([
      loadCSV(bust(base + "kpi_pass_rate.csv")),
      loadCSV(bust(base + "assessment_turnaround_bins.csv")),
      loadCSV(bust(base + "engagement_index.csv")),
      loadCSV(bust(base + "at_risk_modules.csv"))
    ]);
  } catch (e) {
    alert("Could not load CSVs from docs/data/. Check that the four CSVs exist.");
    return;
  }

  // ---------- normalize helpers ----------
  const by = (arr, key) => arr.reduce((m,d)=>((m[d[key]]??=[]).push(d),m),{});

  function normalizeRisk(rows){
    const clean = (v) => (typeof v === "string" ? v.trim() : v);
    const TRUE_SET  = new Set(["true","1","yes","y"]);
    const FALSE_SET = new Set(["false","0","no","n",""]);
    const asBool = (v) => {
      const s = String(clean(v ?? "")).toLowerCase();
      if (TRUE_SET.has(s))  return true;
      if (FALSE_SET.has(s)) return false;
      return Boolean(v);
    };
    return (rows || [])
      .filter(r => r && r.module_id !== undefined && r.module_id !== "")
      .map(r => {
        const pass = clean(r.pass_rate   ?? r["pass_rate "]);
        const surv = clean(r.mean_survey ?? r["mean_survey "]);
        const flag = clean(r.at_risk     ?? r["at_risk "]);
        return {
          module_id: Number(clean(r.module_id)),
          pass_rate: pass === "" || pass == null ? null : Number(pass),
          mean_survey: surv === "" || surv == null ? null : Number(surv),
          at_risk: asBool(flag),
        };
      });
  }
  const riskClean = normalizeRisk(risk);

  // ---------- KPIs ----------
  function computeKPIs(pp, trn, e, rk){
    const overallPass = (
      pp.reduce((s,d)=>s+(+d.pass_rate_pct||0),0) / Math.max(pp.length,1)
    ).toFixed(1) + "%";
    const pctTurn15 = (
      trn.filter(d => ["<=10","11-15"].includes(String(d.turn_bin))).length /
      Math.max(trn.length,1) * 100
    ).toFixed(0) + "%";
    const engMed = e.map(d=>+d.engagement_index||0).sort((a,b)=>a-b)[Math.floor(e.length/2)];
    const riskCnt = riskClean.filter(d => d.at_risk === true).length;
    return { overallPass, pctTurn15, engMed: (engMed==null? "—" : engMed.toFixed(2)), riskCnt };
  }
  const k = computeKPIs(progPass, turn, eng, riskClean);
  document.getElementById("kpiPass").textContent = k.overallPass;
  document.getElementById("kpiTurn").textContent = k.pctTurn15;
  document.getElementById("kpiEng").textContent  = k.engMed;
  document.getElementById("kpiRisk").textContent = k.riskCnt;

  // ---------- Charts ----------
  // 1) Programme pass rates by term (legend below)
  const series = by(progPass, "programme");
  const traces1 = Object.entries(series).map(([name,rows]) => ({
    name, type:"scatter", mode:"lines+markers",
    x: rows.map(r=>r.term), y: rows.map(r=>r.pass_rate_pct)
  }));
  Plotly.newPlot("fig1", traces1, {
    xaxis:{title:"Term"}, yaxis:{title:"Pass rate (%)"},
    legend: bottomLegend(), margin:{t:10}
  });

  // 2) Turnaround distribution
  const bins = ["<=10","11-15","16-20",">20"];
  const counts = bins.map(b => turn.filter(d=>String(d.turn_bin)===b).length);
  Plotly.newPlot("fig2", [{x:bins,y:counts,type:"bar"}], {margin:{t:10}, showlegend:false});

  // 3) Engagement vs pass (programme/term points)
  // map engagement onto pass by programme+term
  const key = (p,t)=>`${p}|||${t}`;
  const engMap = new Map(eng.map(d=>[key(d.programme,d.term), d.engagement_index]));
  const merged = progPass.map(d=>({ ...d, engagement_index: engMap.get(key(d.programme,d.term)) }));
  Plotly.newPlot("fig3", [{
    x: merged.map(d=>d.engagement_index),
    y: merged.map(d=>d.pass_rate_pct),
    text: merged.map(d=>`${d.programme} ${d.term}`),
    mode:"markers", type:"scatter", name:""
  }], {xaxis:{title:"Engagement index"}, yaxis:{title:"Pass rate (%)"}, margin:{t:10}, showlegend:false});

  // 4) Modules: pass vs survey (at-risk vs higher)
  Plotly.newPlot("fig4", [
    {x: riskClean.filter(d=>d.at_risk).map(d=>d.mean_survey),
     y: riskClean.filter(d=>d.at_risk).map(d=>d.pass_rate),
     mode:"markers", name:"Low satisfaction & pass (at‑risk)", marker:{color:"crimson"}},
    {x: riskClean.filter(d=>!d.at_risk).map(d=>d.mean_survey),
     y: riskClean.filter(d=>!d.at_risk).map(d=>d.pass_rate),
     mode:"markers", name:"Higher satisfaction", marker:{color:"seagreen"}}
  ], {xaxis:{title:"Survey score (1–5)"}, yaxis:{title:"Pass rate (%)"}, legend: bottomLegend(), margin:{t:10}});

  // 5) Segment #5 — ≤ medians on fig3
  const engVals  = merged.map(d=>+d.engagement_index||0).sort((a,b)=>a-b);
  const passVals = merged.map(d=>+d.pass_rate_pct||0).sort((a,b)=>a-b);
  const medEng   = engVals[Math.floor(engVals.length/2)] || 0;
  const medPass  = passVals[Math.floor(passVals.length/2)] || 0;
  const seg5 = merged.filter(d => (+d.engagement_index||0) <= medEng && (+d.pass_rate_pct||0) <= medPass);
  Plotly.newPlot("fig5", [{
    x: seg5.map(d=>d.engagement_index),
    y: seg5.map(d=>d.pass_rate_pct),
    text: seg5.map(d=>`${d.programme} ${d.term}`),
    mode:"markers", name:""
  }], {
    shapes:[
      {type:"line", x0:medEng, x1:medEng, y0:0, y1:1, yref:"paper", line:{dash:"dot"}},
      {type:"line", y0:medPass, y1:medPass, x0:0, x1:1, xref:"paper", line:{dash:"dot"}}
    ],
    xaxis:{title:"Engagement index"}, yaxis:{title:"Pass rate (%)"},
    margin:{t:10}, showlegend:false
  });

  // 6) Modules — ≤ median pass, split by at‑risk
  const modPassMed = riskClean.map(d=>+d.pass_rate||0).sort((a,b)=>a-b)[Math.floor(riskClean.length/2)] || 0;
  const seg6 = riskClean.filter(d => (+d.pass_rate||0) <= modPassMed);
  Plotly.newPlot("fig6", [
    {x: seg6.filter(d=>d.at_risk).map(d=>d.mean_survey),
     y: seg6.filter(d=>d.at_risk).map(d=>d.pass_rate),
     mode:"markers", name:"Low satisfaction & pass (at‑risk)", marker:{color:"crimson"}},
    {x: seg6.filter(d=>!d.at_risk).map(d=>d.mean_survey),
     y: seg6.filter(d=>!d.at_risk).map(d=>d.pass_rate),
     mode:"markers", name:"Higher satisfaction", marker:{color:"seagreen"}}
  ], {
    shapes:[{type:"line", y0:modPassMed, y1:modPassMed, x0:0, x1:1, xref:"paper", line:{dash:"dot"}}],
    xaxis:{title:"Survey score (1–5)"}, yaxis:{title:"Pass rate (%)"},
    legend: bottomLegend(), margin:{t:10}
  });

  // ---------- Table (null-safe) ----------
  const cols = [
    { title:"module_id",   data:"module_id",   defaultContent:"—" },
    { title:"pass_rate",   data:"pass_rate",   defaultContent:"—" },
    { title:"mean_survey", data:"mean_survey", defaultContent:"—" },
    { title:"at_risk",     data:"at_risk",     defaultContent:"—" }
  ];
  if ($.fn.dataTable.isDataTable("#modTable")) $("#modTable").DataTable().destroy();
  $("#modTable").empty();
  $("#modTable").DataTable({ data: riskClean, columns: cols, pageLength: 10, order: [[1,"asc"]] });
})();
</script>
</body>
</html>